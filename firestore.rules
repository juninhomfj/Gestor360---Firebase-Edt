rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helpers robustos
    function isSignedIn() {
      return request.auth != null;
    }

    // Verifica se o usuário logado tem papel administrativo com fallback seguro
    function isAdmin() {
      return isSignedIn() && 
        get(/databases/$(database)/documents/profiles/$(request.auth.uid)).data.get('role', 'USER') in ['ADMIN', 'DEV'];
    }

    // Regra de propriedade ou administração global
    function isOwner(res) {
      return isSignedIn() && (
        res == null || 
        res.data.get('userId', '') == request.auth.uid || 
        isAdmin()
      );
    }

    // Regras por Coleção
    
    // Dados Privados (Dono ou Admin)
    match /sales/{id} { allow read, write: if isOwner(resource); }
    match /transactions/{id} { allow read, write: if isOwner(resource); }
    match /accounts/{id} { allow read, write: if isOwner(resource); }
    match /cards/{id} { allow read, write: if isOwner(resource); }
    match /categories/{id} { allow read, write: if isOwner(resource); }
    match /goals/{id} { allow read, write: if isOwner(resource); }
    match /challenges/{id} { allow read, write: if isOwner(resource); }
    match /challenge_cells/{id} { allow read, write: if isOwner(resource); }
    match /receivables/{id} { allow read, write: if isOwner(resource); }
    match /clients/{id} { allow read, write: if isOwner(resource); }
    match /wa_contacts/{id} { allow read, write: if isOwner(resource); }
    match /wa_campaigns/{id} { allow read, write: if isOwner(resource); }
    match /wa_queue/{id} { allow read, write: if isOwner(resource); }

    // Dados Globais / Configurações
    match /commissions/{docId} {
      allow read: if isSignedIn();
      allow write: if isAdmin(); 
    }

    match /config/{configId} {
      allow read, write: if isSignedIn();
    }

    // Perfil do Usuário (Dono ou Admin pode editar)
    match /profiles/{uid} {
      allow read: if isSignedIn();
      allow write: if isSignedIn() && (request.auth.uid == uid || isAdmin());
    }

    // Mensageria Interna
    match /internal_messages/{msgId} {
      allow read: if isSignedIn() && (
        resource.data.recipientId == request.auth.uid || 
        resource.data.senderId == request.auth.uid ||
        resource.data.recipientId == "BROADCAST" ||
        isAdmin()
      );
      allow create, update: if isSignedIn();
    }

    // Logs de Auditoria
    match /audit_log/{logId} {
      allow create: if isSignedIn();
      allow read: if isAdmin();
    }
  }
}