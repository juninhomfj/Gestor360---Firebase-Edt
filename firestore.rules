rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper: Usuário autenticado
    function isSignedIn() {
      return request.auth != null;
    }

    // Helper: Dono do documento
    function isOwner(res) {
      return isSignedIn() && (res == null || res.data.userId == request.auth.uid);
    }

    // Regras por Coleção
    
    // Dados Privados (Filtro por userId)
    match /sales/{id} { allow read, write: if isOwner(resource); }
    match /transactions/{id} { allow read, write: if isOwner(resource); }
    match /accounts/{id} { allow read, write: if isOwner(resource); }
    match /cards/{id} { allow read, write: if isOwner(resource); }
    match /categories/{id} { allow read, write: if isOwner(resource); }
    match /goals/{id} { allow read, write: if isOwner(resource); }
    match /challenges/{id} { allow read, write: if isOwner(resource); }
    match /challenge_cells/{id} { allow read, write: if isOwner(resource); }
    match /receivables/{id} { allow read, write: if isOwner(resource); }
    match /clients/{id} { allow read, write: if isOwner(resource); }
    match /wa_contacts/{id} { allow read, write: if isOwner(resource); }
    match /wa_campaigns/{id} { allow read, write: if isOwner(resource); }
    match /wa_queue/{id} { allow read, write: if isOwner(resource); }

    // Dados Globais / Configurações (Apenas Autenticados)
    match /commissions/{docId} {
      allow read: if isSignedIn();
      allow write: if isSignedIn(); 
    }

    match /config/{configId} {
      allow read, write: if isSignedIn();
    }

    // Perfil do Usuário
    match /profiles/{uid} {
      allow read: if isSignedIn();
      allow write: if isSignedIn() && (request.auth.uid == uid);
    }

    // Mensageria Interna
    match /internal_messages/{msgId} {
      allow read: if isSignedIn() && (
        resource.data.recipientId == request.auth.uid || 
        resource.data.senderId == request.auth.uid ||
        resource.data.recipientId == "BROADCAST"
      );
      allow create, update: if isSignedIn();
    }

    // Logs de Auditoria
    match /audit_log/{logId} {
      allow create: if isSignedIn();
      allow read: if isSignedIn();
    }
  }
}